ymaps.ready(function() {
    var highlightedDistrict;
    var clicked = false;

    function baloonText(district) {
        return 'Чат: <a href="tg://resolve?domain=' + district.properties.username + '">' + district.properties.name + '</a><br/>\n' +
                'Участников: ' + district.properties.count + '<br/>';
    }

    function mouseEnterHandler(event) {
        var district = event.get('target').getParent();
        district.options.set({fillOpacity: 1});
        var coords = event.get('coords');
        coords[0] = coords[0] + 2;
        districtBalloon.open(
            coords,
            baloonText(district)
        );
    };
    function mouseLeaveHandler(event) {
        var district = event.get('target').getParent();
        if (district !== highlightedDistrict) {
            district.options.set({fillOpacity: 0.5});
            clicked = false;
        }
    };

    function clickEventHandlerMini(event) {
        mouseEnterHandler(event);
        var district = event.get('target').getParent();
        if (highlightedDistrict) highlightedDistrict.options.set({fillOpacity: 0.5});
        highlightedDistrict = district;
    }

    function clickEventHandler(event) {
        var target = event.get('target');
        var district = target.getParent();
        // Если на карте выделен федеральный округ, то мы снимаем с него выделение.
        if (highlightedDistrict) {
            highlightedDistrict.options.set({fillOpacity: 0.5})
        }
        // Откроем балун в точке клика. В балуне будут перечислены регионы того федерального округа,
        // по которому кликнул пользователь.
        districtBalloon.open(event.get('coords'), baloonText(district));
        // Выделим федеральный округ.
        district.options.set({fillOpacity: 1});
        // Сохраним ссылку на выделенный федеральный округ.
        highlightedDistrict = district;
    }

    var map = new ymaps.Map("first_map", {
        center: [60, 80],
        zoom: 3,
        controls: ['zoomControl']
    },{
        //restrictMapArea: [[10, 10], [85,-160]]
    });
    var districtBalloon = new ymaps.Balloon(map);
    districtBalloon.options.setParent(map.options);
    ymaps.borders.load('RU', {
        lang: 'ru',
        quality: 2
    }).then(reg => {
        const features = reg.features;
        <% items.forEach(item => { %>
            (function() {
                var region = new ymaps.GeoObjectCollection(null, {
                    fillColor: '<%= item.color %>',
                    strokeColor: '#000000',
                    strokeOpacity: 0.5,
                    fillOpacity: 0.5,
                    hintCloseTimeout: 0,
                    hintOpenTimeout: 0
                });
                region.properties.count = <%= item.count %>;
                region.properties.name = '<%= item.name %>';
                region.properties.username = '<%= item.username %>';
                <% item.codes.forEach(code => { %>
                region.add(new ymaps.GeoObject(features.find(reg => reg.properties.iso3166 === '<%= code %>')));
                <% }); %>
                map.geoObjects.add(region);
                region.events.add('mouseenter', mouseEnterHandler);
                region.events.add('mouseleave', mouseLeaveHandler);
                region.events.add('click', clickEventHandlerMini);
                /* region.events.add('click', clickEventHandler); */
            })();
        <% }); %>
    });
});
